* [2015-07-07 Di] Modell Ferritin
#+BEGIN_SRC R :session :tangle yes
  setwd("/media/mandy/Volume/transcend/doktoranden/rieger")
  load("daten_komplett.RData")
  require(gamlss)
  require(gamlss.tr)
  require(reshape2)
  require(ggplot2)

  ## erzeuge truncated distribution
  gen.trun(par=c(0),family="NO",type="left")
  gen.trun(par=c(0),family="BCCG",type="left")

  ## ferritin
  ### daten
  tmpdata_boys <- na.omit(daten[daten$SEX==1,c("LAB_FERR_S_NUM_VALUE","AGE","SEX")])
  tmpdata_girls <- na.omit(daten[daten$SEX==2,c("LAB_FERR_S_NUM_VALUE","AGE","SEX")])

  ### modelle
  mmferr_boys <- lms (LAB_FERR_S_NUM_VALUE, AGE, family= LMS, data=tmpdata_boys)
  mmferr_girls <- lms (LAB_FERR_S_NUM_VALUE, AGE, family= LMS, data=tmpdata_girls)

  ## neue modelle
  mmferr_boys2 <- gamlss(LAB_FERR_S_NUM_VALUE ~ pb(AGE), family = BCCGtr, data = tmpdata_boys )
  mmferr_boys2 <- gamlss(LAB_FERR_S_NUM_VALUE ~ cs(AGE), family = BCCGtr, data = tmpdata_boys )

  mmferr_girls2 <- gamlss(LAB_FERR_S_NUM_VALUE ~ pb(AGE), family = BCCGtr, data = tmpdata_girls)

  centiles(mmferr_boys2, xvar=tmpdata_boys$AGE, cent=c(3,10,50,90,97), col.centiles=c("gray0","gray15","gray30","gray45","gray60"), 
           ylab="Ferritin in ng/ml", xlab="Exaktes Alter in Jahren",
           xlim=c(2.5,16),ylim=c(0,110), main="Geglätte Perzentilenkurven für Ferritin (ng/ml) \n Jungen, N = 664",
           legend("topleft",c("P 3","P 10","P 50","P 90","P 97"),lty=1,lwd=2.5,col=c("gray0","gray15","gray30","gray45","gray60")),
           points=TRUE, pch=20, col="gray76", plot=TRUE, lwd=1, las=1)

  centiles(mmferr_girls2, xvar=tmpdata_girls$AGE, cent=c(3,10,50,90,97), col.centiles=c("gray0","gray15","gray30","gray45","gray60"), 
           ylab="Ferritin in ng/ml", xlab="Exaktes Alter in Jahren",
           xlim=c(2.5,16),ylim=c(0,100), main="Geglätte Perzentilenkurven für Ferritin (ng/ml) \n Mädchen, N = 637",
           legend("topleft",c("P 3","P 10","P 50","P 90","P 97"),lty=1,lwd=2.5,col=c("gray0","gray15","gray30","gray45","gray60")),
           points=TRUE, pch=20, col="gray76", plot=TRUE, lwd=1, las=1)

  ## extract values for plotting
  centilesferr1 <- centiles.pred(mmferr_boys2,type="centiles",cent=c(3,50,97),xvalues=seq(3,16,by=0.1),xname="AGE")
  centilesferr2 <- centiles.pred(mmferr_girls2,type="centiles",cent=c(3,50,97),xvalues=seq(3,16,by=0.1),xname="AGE")

  centilesferr1$SEX <- "male"
  centilesferr2$SEX <- "female"

  grdat1 <- melt(centilesferr1,id.vars = c("AGE","SEX"))
  grdat2 <- melt(centilesferr2,id.vars = c("AGE","SEX"))

  grdat <- rbind(grdat1,grdat2)
  tmpdata_boys$SEX <- "male"

  ggplot(grdat,aes(x=AGE,y=value)) +
    geom_line(aes(linetype=SEX,group=paste(SEX,variable))) +
    scale_y_continuous(limits=c(0,110)) +
    theme_bw()
#+END_SRC


* [2015-07-14 Di] Estimating Cluster effect of families
#+BEGIN_SRC R :session :results output
  require(lme4)
  require(gamlss)
  require(gamlss.tr)

  load("daten_komplett.RData")
  daten$PSIC <- gsub(" ","",daten$PSIC)

  tmpdata_boys <- na.omit(daten[daten$SEX==1,c("LAB_FERR_S_NUM_VALUE","AGE","SEX","FAMNR")])

  gen.trun(par=c(0),family="BCCG",type="left")


  mmferr_boys <- gamlss(LAB_FERR_S_NUM_VALUE ~ pb(AGE), family = BCCGtr, data = tmpdata_boys[!duplicated(tmpdata_boys$FAMNR),] )

  tmpdata_boys$sds <- centiles.pred(mmferr_boys,
                                    xname = "AGE",
                                    xvalues = tmpdata_boys$AGE,
                                    yval = tmpdata_boys$LAB_FERR_S_NUM_VALUE,
                                    type = "z-scores")

  mm <- lmer(sds ~ 1 + (1 | FAMNR), data = tmpdata_boys)
  summary(mm)
#+END_SRC

#+RESULTS:
#+begin_example
A truncated family of distributions from BCCG has been generated 
 and saved under the names:  
 dBCCGtr pBCCGtr qBCCGtr rBCCGtr BCCGtr 
The type of truncation is left and the truncation parameter is 0
GAMLSS-RS iteration 1: Global Deviance = 6784.704 
GAMLSS-RS iteration 2: Global Deviance = 6696.853 
GAMLSS-RS iteration 3: Global Deviance = 6694.589 
GAMLSS-RS iteration 4: Global Deviance = 6694.583 
GAMLSS-RS iteration 5: Global Deviance = 6694.569 
GAMLSS-RS iteration 6: Global Deviance = 6694.571 
GAMLSS-RS iteration 7: Global Deviance = 6694.57
 new prediction
Linear mixed model fit by REML ['lmerMod']
Formula: sds ~ 1 + (1 | FAMNR)
   Data: tmpdata_boys

REML criterion at convergence: 3787.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.2090 -0.4981  0.0160  0.4703  3.8183 

Random effects:
 Groups   Name        Variance Std.Dev.
 FAMNR    (Intercept) 0.5430   0.7369  
 Residual             0.4769   0.6906  
Number of obs: 1410, groups:  FAMNR, 781

Fixed effects:
            Estimate Std. Error t value
(Intercept) 0.009033   0.033083   0.273
#+end_example

